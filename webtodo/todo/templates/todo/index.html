{% extends "todo/base.html" %}

{% block extrahead %}
{% endblock %}

{% block content %}
<div class="logout">
  <a href="{% url 'todo:logout' %}">Log out</a>
</div>
<h1>Todo tasks</h1>
<div class="input-form">
  <input type="text" class="todo-text" id="todo_text" name="todo_text" placeholder="Input todo here" />
</div>
<div id="todo_list" class="todo-list">
  {% for todo in todo_list %}
  <div class="todo" draggable="true">
    <input type="hidden" name="todo_id" value="{{ todo.id }}" />
    <p class="todo-text">{{ todo.todo_text }}</p>
  </div>
  {% endfor %}
</div>
</ul>
{% endblock %}

{% block footer-script %}
<script type="text/javascript">
      var dragSourceElement = null;

      function handleDragStart(e) {
        this.style.opacity = 0.4;

        dragSourceElement = this;

        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', this.innerHTML);
      }

      function handleDragOver(e) {
        if (e.preventDefault) {
          e.preventDefault();
        }
        e.dataTransfer.droppEffect = 'move';
        return false;
      }

      function handleDragEnter(e) {
        this.classList.add('over');
      }

      function handleDragLeave(e) {
        this.classList.remove('over');
      }

      function handleDragEnd(e) {
        var todos = document.querySelectorAll('#todo_list .todo');
        [].forEach.call(todos, function(todo) {
          todo.classList.remove('over');
        });
      }

      function handleDrop(e) {
        dragSourceElement.style.opacity = 1;

        if (e.stopPropagation) {
          e.stopPropagation();
        }

        if (dragSourceElement != this) {
          dragSourceElement.innerHTML = this.innerHTML;
          this.innerHTML = e.dataTransfer.getData('text/html');
        }

        return false;
      }

      // register drag and drop events
      var todos = document.querySelectorAll('#todo_list .todo');
      [].forEach.call(todos, function(todo) {
        todo.addEventListener('dragstart', handleDragStart, false);
        todo.addEventListener('dragenter', handleDragEnter, false);
        todo.addEventListener('dragover', handleDragOver, false);
        todo.addEventListener('dragleave', handleDragLeave, false);
        todo.addEventListener('drop', handleDrop, false);
        todo.addEventListener('dragend', handleDragEnd, false);
      });

      // register enter event
      document.getElementById('todo_text').addEventListener('keydown', function(event) {
        if (event.keyCode == 13) {
          document.getElementById('todo_list').insertAdjacentHTML(
            'afterbegin',
            '<div class="todo" draggable="true">\n' +
            '  <input type="hidden" name="todo_id" value="" />\n' +
            '  <p class="todo-text">' + this.value + '</p>\n' +
            '</div>'
          );

          // add event
          var todo = document.querySelector('#todo_list .todo');
          todo.addEventListener('dragstart', handleDragStart, false);
          todo.addEventListener('dragenter', handleDragEnter, false);
          todo.addEventListener('dragover', handleDragOver, false);
          todo.addEventListener('dragleave', handleDragLeave, false);
          todo.addEventListener('drop', handleDrop, false);
          todo.addEventListener('dragend', handleDragEnd, false);

          this.value = '';
        }
      });
</script>
{% endblock %}
